<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard · Monitoreo de Patrullajes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />

  <link rel="stylesheet" href="css/dashboard.css?v=16" />

  <!-- tabla de Reportes -->
  <style>
    #tblResumen th,
    #tblResumen td{
      text-align:center;
    }
    /*  "Patrulla" a la izquierda,  */
    /* #tblResumen th:first-child, #tblResumen td:first-child { text-align:left; } */

    /* ====== Logos de instituciones (PNC / SGAIA) ====== */
    .org-badges{
      display:flex; align-items:center; gap:10px;
      margin-left:10px;
    }
    .org-badges img.orglogo{
      width:30px; height:30px;
      display:block;
      border-radius:6px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:4px; /* pequeño margen interior para que el SVG no quede pegado */
      box-shadow:0 4px 14px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }
    @media (max-width:700px){
      .org-badges img.orglogo{ width:24px; height:24px; }
    }
  </style>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ===== Sirena pulsante (CSS) — ROJO y un poco más grande ===== -->
  <style>
    /* Wrapper del icono para el divIcon (área clickable) */
    .pulse-icon{ width:37px; height:37px; }

    /* Contenedor del efecto (se dibuja centrado) */
    .pulse-marker{
      position:relative; width:40px; height:40px; pointer-events:none;
      --pulse-color:#ef4444; /* rojo por defecto */
    }

    /* Punto central */
    .pulse-marker .dot{
      position:absolute; left:50%; top:50%;
      width:16px; height:16px; margin:-8px 0 0 -8px;
      background:var(--pulse-color); border-radius:50%;
      box-shadow:0 0 0 2px rgba(239,68,68,.35);
    }

    /* Anillo que se expande */
    .pulse-marker .ring{
      position:absolute; left:50%; top:50%;
      width:40px; height:40px; margin:-20px 0 0 -20px;
      background:rgba(239,68,68,.25); border-radius:50%;
      animation:pulseWave 1.8s ease-out infinite;
    }

    @keyframes pulseWave{
      0%   { transform:scale(.4); opacity:.9; }
      70%  { transform:scale(1.0); opacity:.15; }
      100% { transform:scale(1.2); opacity:0; }
    }
  </style>
  <!-- ================================== -->
</head>
<body>
  <header class="topbar">
    <h1>Monitoreo de Patrullajes</h1>

    <!-- NUEVO: Badges con logos -->
    <div class="org-badges" aria-label="Instituciones">
      <img class="orglogo" src="img/pnc.svg" alt="PNC" title="PNC" />
      <img class="orglogo" src="img/sgaia.svg" alt="SGAIA" title="SGAIA" />
    </div>

    <nav class="top-actions" style="margin-left:auto; margin-right:12px;">
      <a id="linkUsers" class="btn btn-callout" href="usuarios.html">Usuarios</a>
      <a id="linkPatrullas" class="btn btn-callout" href="patrullas.html">Patrullas</a>
    </nav>

    <!-- Última actualización visible en header -->
    <span class="lastupdate" style="margin-right:16px;color:#8aa0c8;font-size:.9rem;white-space:nowrap;">
    
    
      Última actualización: <strong id="kpiUltimaTop" style="color:#e7eefb;">—</strong>
    </span>

    <span>Usuario:
      <strong id="userEmail">—</strong>
      <small id="userRole" class="muted" style="margin-left:6px;">—</small>
    </span>
    <!-- Botón salir  -->
    <button id="btnLogout" type="button" class="btn btn-danger">Salir</button>

    <!-- (Oculto, lo usamos para sincronizar el texto del header) -->
    <span id="kpiUltima" class="sr-only">—</span>
  </header>

  <main class="grid">
    <!-- Columna izquierda: KPIs (fila 1) -->
    <section class="kpis">
      <div class="kpi kpi--chip">
        <div class="kpi__label">Patrullas</div>
        <div class="kpi__value" id="kpiTotal">—</div>
      </div>
      <div class="kpi kpi--chip">
        <div class="kpi__label">Activas</div>
        <div class="kpi__value" id="kpiActivas">—</div>
      </div>
    </section>

    <!-- Columna derecha: MAPA -->
    <section class="panel" style="grid-row: span 2;">
      <h2>Mapa</h2>
      <div class="map-wrap" id="mapWrap">
        <button id="btnMapFS" class="map-btn" type="button" title="Pantalla completa" aria-label="Pantalla completa" aria-pressed="false">
          <!-- Ícono “expandir” -->
          <svg id="icoExpand" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path>
            <path d="M21 3l-7 7"></path><path d="M3 21l7-7"></path>
          </svg>
          <!-- Ícono “contraer” (oculto por defecto) -->
          <svg id="icoCompress" style="display:none" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 14v6h6"></path><path d="M20 10V4h-6"></path>
            <path d="M14 20l6-6"></path><path d="M4 10l6-6"></path>
          </svg>
        </button>
        <div id="map" class="map"></div>
      </div>
    </section>

    <!-- Columna izquierda, REPORTES -->
    <section class="panel" id="panelReportes">
      <div class="panel__header" style="display:flex;align-items:center;gap:8px;">
        <h2 style="margin-right:auto">Reportes</h2>
        <select id="repRange" class="input">
          <option value="7">Últimos 7 días</option>
          <option value="14" selected>Últimos 14 días</option>
          <option value="30">Últimos 30 días</option>
        </select>
        <button id="btnExportCSV" class="btn btn-small">Exportar CSV</button>
      </div>

      <div style="overflow:auto; max-height: 260px;">
        <table class="table" id="tblResumen">
          <thead>
            <tr>
              <th>Patrulla</th>
              <th>Reportes</th>
              <th>Primera vez</th>
              <th>Última vez</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Izquierda Ubicaciones / Derecha Estadísticas -->
    <section class="panel">
      <div class="panel__header">
        <h2>Ubicaciones recientes</h2>
        <div class="panel__actions">
          <select id="ubiRange" class="input">
            <option value="1h">Últ. 1 h</option>
            <option value="6h">Últ. 6 h</option>
            <option value="24h" selected>Últ. 24 h</option>
            <option value="7d">Últ. 7 días</option>
            <option value="30d">Últ. 30 días</option>
            <option value="all">Todo</option>
          </select>
          <button id="btnExportUbicCSV" class="btn btn-small">Exportar CSV</button>
        </div>
      </div>

      <div style="max-height: 320px; overflow: auto;">
        <table class="table" id="tblUbicaciones">
          <thead>
            <tr>
              <th>Patrulla</th>
              <th>Lat</th>
              <th>Lng</th>
              <th>Estado</th>
              <th>Actualizado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <div class="panel__header">
        <h2>Estadísticas</h2>
        <div class="panel__actions">
          <select id="rangeDays" class="input">
            <option value="7">Últimos 7 días</option>
            <option value="14" selected>Últimos 14 días</option>
            <option value="30">Últimos 30 días</option>
          </select>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:300px 1fr;gap:16px;">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="kpi" style="display:flex;flex-direction:column;justify-content:center;">
            <div class="kpi__label">Patrullas activas ahora</div>
            <div class="kpi__value" id="kpiActivasNow">—</div>
          </div>

          <div style="display:flex;gap:16px;align-items:center;">
            <div style="width:140px;height:140px;">
              <canvas id="donutActivas"></canvas>
            </div>
            <div class="muted">
              <div><strong id="lblActivas">—</strong> activas</div>
              <div><strong id="lblInactivas">—</strong> inactivas</div>
            </div>
          </div>
        </div>

        <div style="min-height:260px;">
          <canvas id="chartPatrullajes" height="120"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- API backend -->
  <script>
    window.API_BASE_URL = "http://localhost:5000/api";
  </script>

  <!-- Protección (auth)-->
  <script type="module">
    import { GuardController } from "./src/controllers/GuardController.js?v=3";
    const guard = new GuardController({
      btnLogoutSel: "#btnLogout",
      userEmailSel: "#userEmail",
      userRoleSel:  "#userRole",
      usersLinkSel: "#linkUsers",
      patrullasLinkSel: "#linkPatrullas",
    });
    guard.init();
  </script>

  <!-- Dashboard -->
  <script type="module">
    import { DashboardController } from "./src/controllers/DashboardController.js?v=3";
    const controller = new DashboardController();
    controller.init();
  </script>

  <!-- ===== Estadísticas (barras + donut) ===== -->
  <script type="module">
    import { jsonFetch } from "./src/services/api.js?v=8";

    const elKpiActivasNow = document.getElementById("kpiActivasNow");
    const elRangeDays     = document.getElementById("rangeDays");

    const ctxBars   = document.getElementById("chartPatrullajes");
    const ctxDonut  = document.getElementById("donutActivas");

    const lblAct    = document.getElementById("lblActivas");
    const lblInact  = document.getElementById("lblInactivas");

    let barChart = null;
    let donutChart = null;

    const toDateKey = (d) =>
      new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);

    function buildEmptySeries(days=14) {
      const today = new Date();
      const map = new Map();
      for (let i = days-1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        map.set(toDateKey(d), 0);
      }
      return map;
    }

    async function fetchActivasVsInactivas() {
      const res = await jsonFetch("/patrullas", { method: "GET" });
      const arr = Array.isArray(res?.items) ? res.items : (Array.isArray(res) ? res : []);
      const activas = arr.filter(p => p.is_activa === true).length;
      const inactivas = Math.max(arr.length - activas, 0);
      return { activas, inactivas };
    }

    async function fetchPatrullajesGrouped(days=14) {
      const res = await jsonFetch("/ubicaciones", { method: "GET" });
      const items = Array.isArray(res?.items) ? res.items
                  : Array.isArray(res) ? res
                  : Array.isArray(res?.data) ? res.data
                  : [];

      const series = buildEmptySeries(days);

      for (const it of items) {
        const ts = it.ts || it.updated_at || it.created_at;
        if (!ts) continue;
        const d = new Date(ts);
        const key = toDateKey(d);
        if (series.has(key)) series.set(key, (series.get(key) || 0) + 1);
      }

      return { labels: [...series.keys()], data: [...series.values()] };
    }

    function renderBars(labels, data) {
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxBars, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Patrullajes por día",
            data,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              title: {
                display: true,
                text: "Patrullajes",
                color: "#8aa0c8",
                font: { size: 12, weight: "600" }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (c) => ` ${c.parsed.y} patrullajes` }
            }
          }
        }
      });
    }

    function renderDonut(activas, inactivas) {
      if (donutChart) {
        donutChart.data.datasets[0].data = [activas, inactivas];
        donutChart.update();
        return;
      }
      donutChart = new Chart(ctxDonut, {
        type: "doughnut",
        data: {
          labels: ["Activas", "Inactivas"],
          datasets: [{
            data: [activas, inactivas],
            backgroundColor: ["#22c55e", "#334155"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          cutout: "65%",
          plugins: { legend: { display: false } }
        }
      });
    }

    async function loadStats() {
      try {
        const { activas, inactivas } = await fetchActivasVsInactivas();
        elKpiActivasNow.textContent = activas;
        if (lblAct)   lblAct.textContent = activas;
        if (lblInact) lblInact.textContent = inactivas;
        renderDonut(activas, inactivas);

        const days = Number(elRangeDays.value || 14);
        const { labels, data } = await fetchPatrullajesGrouped(days);
        renderBars(labels, data);
      } catch (e) {
        console.error("[stats] error:", e);
      }
    }

    elRangeDays.addEventListener("change", loadStats);
    loadStats();
  </script>

  <!-- Sincroniza #kpiUltima con el header -->
  <script>
    (function syncLastUpdate(){
      const src = document.getElementById('kpiUltima');
      const dst = document.getElementById('kpiUltimaTop');
      if (!src || !dst) return;
      const sync = () => { dst.textContent = src.textContent || '—'; };
      const mo = new MutationObserver(sync);
      mo.observe(src, { childList: true, characterData: true, subtree: true });
      sync();
    })();
  </script>

  <!-- Toggle de pantalla completa del mapa -->
  <script>
    (function(){
      const wrap = document.getElementById('mapWrap');
      const btn  = document.getElementById('btnMapFS');
      const icoExpand   = document.getElementById('icoExpand');
      const icoCompress = document.getElementById('icoCompress');
      if (!wrap || !btn || !icoExpand || !icoCompress) return;

      btn.addEventListener('click', () => {
        const isFs = wrap.classList.toggle('map--fullscreen');
        btn.setAttribute('aria-pressed', String(isFs));
        icoExpand.style.display   = isFs ? 'none' : '';
        icoCompress.style.display = isFs ? '' : 'none';
        setTimeout(() => {
          if (window.__leaflet_map && typeof window.__leaflet_map.invalidateSize === 'function') {
            window.__leaflet_map.invalidateSize();
          }
        }, 150);
      });
    })();
  </script>

  <!-- ======= Reportes: Resumen por patrulla + CSV ======= -->
  <script type="module">
    import { jsonFetch } from "./src/services/api.js?v=8";

    const $ = (s)=>document.querySelector(s);
    const tbody   = $("#tblResumen tbody");
    const rangeEl = $("#repRange");
    const btnCSV  = $("#btnExportCSV");

    function fmtDate(ts){ return ts ? new Date(ts).toLocaleString() : "—"; }

    // Catálogo de patrullas
    async function fetchPatrolIndex(){
      try{
        const res = await jsonFetch("/patrullas", { method:"GET" });
        const arr = Array.isArray(res?.items) ? res.items : (Array.isArray(res) ? res : []);
        const idx = new Map();
        for(const p of arr){
          const id = p.id ?? p.patrulla_id ?? p.uid ?? p._id;
          const display = p.nombre ?? p.name ?? p.codigo ?? p.code ?? p.alias ?? `Patrulla ${id ?? ""}`.trim();
          if(id != null) idx.set(id, String(display));
        }
        return idx;
      }catch(e){
        console.warn("[reportes] no se pudo indexar patrullas:", e);
        return new Map();
      }
    }

    function getPatrolNameFlexible(item, index){
      const pid = item.patrulla_id ?? item.patrullaId ?? item.id_patrulla ?? item.vehicle_id ?? item.unidad_id ?? item.patrol_id;
      if (pid != null) {
        const byId = index.get(pid);
        if (byId) return byId;
      }
      const direct =
        item.patrulla ?? item.Patrulla ??
        item.unidad ?? item.unidad_nombre ??
        item.vehicle ?? item.vehiculo ??
        item.codigo ?? item.code ??
        item.alias ?? item.nombre ?? item.name;
      if (typeof direct === "string" && direct.trim()) return direct.trim();

      for (const k of Object.keys(item)) {
        if (/(patrull|unidad|vehic|alias|cod|nombre|name)/i.test(k)) {
          const v = item[k];
          if (typeof v === "string" && v.trim()) return v.trim();
        }
      }
      return "—";
    }

    function csvEscape(val){
      const s = String(val ?? "").replace(/"/g,'""');
      return `"${s}"`;
    }

    function exportCSV(rows){
      const header = ["Patrulla","Reportes","Primera vez","Última vez"];
      const lines = [header.map(csvEscape).join(",")];
      for(const r of rows){
        lines.push([
          csvEscape(r.patrulla),
          csvEscape(r.count),
          csvEscape(fmtDate(r.first_ts)),
          csvEscape(fmtDate(r.last_ts))
        ].join(","));
      }
      const csvContent = "\uFEFF" + lines.join("\r\n");
      const blob = new Blob([csvContent], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "resumen_patrullas.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    async function loadResumen(){
      const days = Number(rangeEl.value || 14);
      const since = Date.now() - days*24*60*60*1000;

      const patrolIdx = await fetchPatrolIndex();

      const res = await jsonFetch("/ubicaciones", { method:"GET" });
      const items = Array.isArray(res?.items) ? res.items
                  : Array.isArray(res) ? res
                  : Array.isArray(res?.data) ? res.data : [];

      const within = items.filter(i => {
        const ts = new Date(i.ts || i.updated_at || i.created_at).getTime();
        return Number.isFinite(ts) && ts >= since;
      });

      const map = new Map();
      for(const it of within){
        const label = getPatrolNameFlexible(it, patrolIdx);
        const ts = new Date(it.ts || it.updated_at || it.created_at).getTime();
        if(!map.has(label)) map.set(label, { patrulla:label, count:0, first_ts:ts, last_ts:ts });
        const g = map.get(label);
        g.count++;
        if(ts < g.first_ts) g.first_ts = ts;
        if(ts > g.last_ts)  g.last_ts  = ts;
      }

      const rows = [...map.values()].sort((a,b)=>b.last_ts - a.last_ts);

      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.patrulla}</td>
          <td>${r.count}</td>
          <td>${fmtDate(r.first_ts)}</td>
          <td>${fmtDate(r.last_ts)}</td>
        </tr>
      `).join("");

      btnCSV.onclick = ()=>exportCSV(rows);
    }

    rangeEl.addEventListener("change", loadResumen);
    loadResumen();
  </script>

  <!-- ===== Sirena pulsante (helper Leaflet) — ROJO y más grande ===== -->
  <script>
    (function(){
      const queue = [];
      const ready = () => !!window.__leaflet_map && !!window.L;

      function makePulsingIcon(color='#ef4444'){
        return L.divIcon({
          className:'pulse-icon',
          html:`<div class="pulse-marker" style="--pulse-color:${color}">
                  <span class="ring"></span><span class="dot"></span>
                </div>`,
          iconSize:[36,36],
          iconAnchor:[18,18]
        });
      }

      function boot(){
        const map = window.__leaflet_map;
        if (!map || !window.L) return;
        const layer = L.layerGroup().addTo(map);
        layer.setZIndex(10000);
        const markers = new Map();

        window.setPulsingPatrol = (id, lat, lng, opts={})=>{
          if(!id || lat==null || lng==null) return;
          const color = opts.color || '#ef4444';
          const latlng = [lat, lng];
          let m = markers.get(id);
          if(!m){
            m = L.marker(latlng, { icon: makePulsingIcon(color), zIndexOffset:9999 }).addTo(layer);
            markers.set(id, m);
          }else{
            m.setLatLng(latlng).setIcon(makePulsingIcon(color));
          }
        };

        window.removePulsingPatrol = (id)=>{
          const m = markers.get(id);
          if(m){ layer.removeLayer(m); markers.delete(id); }
        };

        window.clearPulsingPatrols = ()=>{
          layer.clearLayers(); markers.clear();
        };

        while(queue.length){ (queue.shift())(); }
      }

      if (ready()) boot();
      else {
        const t = setInterval(()=>{ if(ready()){ clearInterval(t); boot(); } }, 120);
      }

      window.__whenPulseReady = (fn)=>{
        if(typeof fn!=="function") return;
        if(ready() && window.setPulsingPatrol) fn(); else queue.push(fn);
      };
    })();
  </script>
  <!-- =========================================== -->

  <noscript>Activa JavaScript para usar el dashboard.</noscript>
</body>
</html>
